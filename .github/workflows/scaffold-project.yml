name: ðŸš€ Scaffold New Project

on:
  push:
    branches: 
      - main
      - 'feat/**'
      - 'fix/**'
      - 'feature/**'
      - 'hotfix/**'
      - 'release/**'
  pull_request:
    types: [opened, synchronize, reopened]
    branches: 
      - main
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Nom du projet'
        required: true
        type: string
      team_name:
        description: 'Ã‰quipe propriÃ©taire'
        required: true
        type: string
      environment:
        description: 'Environnement'
        required: true
        type: choice
        options:
          - dev
          - recette
          - preprod
          - prod
      description:
        description: 'Description du projet (optionnel)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  PROJECT_MANIFESTS_REPO: "younesbami/project-manifests"

jobs:
  scaffold-baseline:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup variables
      run: |
        # Variables pour workflow_dispatch (manuel)
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "PROJECT_NAME=${{ github.event.inputs.project_name }}" >> $GITHUB_ENV
          echo "TEAM_NAME=${{ github.event.inputs.team_name }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "DESCRIPTION=${{ github.event.inputs.description }}" >> $GITHUB_ENV
          echo "MODE=manual" >> $GITHUB_ENV
        else
          # Variables par dÃ©faut pour push/PR automatiques
          echo "PROJECT_NAME=auto-test" >> $GITHUB_ENV
          echo "TEAM_NAME=platform" >> $GITHUB_ENV
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          echo "DESCRIPTION=Test automatique sur ${{ github.event_name }}" >> $GITHUB_ENV
          echo "MODE=auto" >> $GITHUB_ENV
        fi
        
        echo "ðŸ”§ Mode: $([ "${{ github.event_name }}" = "workflow_dispatch" ] && echo "Manual" || echo "Auto")"
        echo "ðŸ“‹ Event: ${{ github.event_name }}"
        
    - name: Generate project baseline
      run: |
        echo "ðŸš€ CrÃ©ation du projet: $PROJECT_NAME-$ENVIRONMENT pour l'Ã©quipe $TEAM_NAME"
        
        # CrÃ©er la structure baseline
        mkdir -p "environments/$ENVIRONMENT/$PROJECT_NAME"
        
        # GÃ©nÃ©rer ResourceQuota
        cat > "environments/$ENVIRONMENT/$PROJECT_NAME/resourcequota.yaml" <<EOF
        apiVersion: v1
        kind: ResourceQuota
        metadata:
          name: baseline-quota
          namespace: $PROJECT_NAME-$ENVIRONMENT
          labels:
            platform.example.com/project: "$PROJECT_NAME"
            platform.example.com/environment: "$ENVIRONMENT"
            platform.example.com/team: "$TEAM_NAME"
            platform.example.com/managed-by: "project-as-code"
        spec:
          hard:
            requests.cpu: "2"
            requests.memory: "4Gi"
            limits.cpu: "4"
            limits.memory: "8Gi"
            requests.storage: "10Gi"
            persistentvolumeclaims: "5"
            pods: "20"
            services: "10"
            secrets: "10"
            configmaps: "20"
        EOF
        
        # GÃ©nÃ©rer RBAC
        cat > "environments/$ENVIRONMENT/$PROJECT_NAME/rbac.yaml" <<EOF
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: $PROJECT_NAME-sa
          namespace: $PROJECT_NAME-$ENVIRONMENT
          labels:
            platform.example.com/project: "$PROJECT_NAME"
            platform.example.com/environment: "$ENVIRONMENT"
            platform.example.com/team: "$TEAM_NAME"
            platform.example.com/managed-by: "project-as-code"
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: Role
        metadata:
          name: $PROJECT_NAME-developer
          namespace: $PROJECT_NAME-$ENVIRONMENT
          labels:
            platform.example.com/project: "$PROJECT_NAME"
            platform.example.com/environment: "$ENVIRONMENT"
            platform.example.com/team: "$TEAM_NAME"
            platform.example.com/managed-by: "project-as-code"
        rules:
          - apiGroups: [""]
            resources: ["pods", "services", "configmaps", "secrets"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
          - apiGroups: ["apps"]
            resources: ["deployments", "replicasets"]
            verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
        ---
        apiVersion: rbac.authorization.k8s.io/v1
        kind: RoleBinding
        metadata:
          name: $PROJECT_NAME-developers
          namespace: $PROJECT_NAME-$ENVIRONMENT
          labels:
            platform.example.com/project: "$PROJECT_NAME"
            platform.example.com/environment: "$ENVIRONMENT"
            platform.example.com/team: "$TEAM_NAME"
            platform.example.com/managed-by: "project-as-code"
        subjects:
          - kind: ServiceAccount
            name: $PROJECT_NAME-sa
            namespace: $PROJECT_NAME-$ENVIRONMENT
        roleRef:
          kind: Role
          name: $PROJECT_NAME-developer
          apiGroup: rbac.authorization.k8s.io
        EOF
        
        # Note: Le manifeste XProjectCluster sera crÃ©Ã© dans project-manifests
        # par un job sÃ©parÃ© pour respecter la sÃ©paration des responsabilitÃ©s
        
        echo "âœ… Baseline gÃ©nÃ©rÃ©e pour $PROJECT_NAME-$ENVIRONMENT"
        
    - name: Create PR for baseline  
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # CrÃ©er une branche unique avec timestamp
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        BRANCH_NAME="add-baseline-$PROJECT_NAME-$ENVIRONMENT-$TIMESTAMP"
        
        git checkout -b "$BRANCH_NAME"
        
        git add .
        git commit -m "Add project baseline: $PROJECT_NAME-$ENVIRONMENT

        - Ã‰quipe: $TEAM_NAME
        - Environnement: $ENVIRONMENT  
        - ResourceQuota avec limites standard
        - RBAC pour dÃ©veloppeurs
        
        Description: $DESCRIPTION
        
        Generated at: $(date)
        /cc @platform-team"
        
        # Force push pour Ã©viter les conflits
        git push origin "$BRANCH_NAME" --force
        
        echo "âœ… Branche crÃ©Ã©e pour baseline: $BRANCH_NAME"
        
        # CrÃ©er la PR directement dans le mÃªme step
        echo "ðŸ”§ CrÃ©ation de la Pull Request..."
        gh pr create \
          --title "ðŸš€ Add project baseline: $PROJECT_NAME-$ENVIRONMENT" \
          --body "## ðŸ—ï¸ Nouveau projet baseline

        **Projet:** \`$PROJECT_NAME\`  
        **Ã‰quipe:** \`$TEAM_NAME\`  
        **Environnement:** \`$ENVIRONMENT\`

        ### ðŸ“‹ Contenu gÃ©nÃ©rÃ©
        - âœ… ResourceQuota avec limites standard
        - âœ… RBAC (ServiceAccount + Role + RoleBinding)
        - âœ… Labels standardisÃ©s pour gouvernance

        ### ðŸŽ¯ Validation requise
        - [ ] VÃ©rifier les limites ResourceQuota
        - [ ] Valider les permissions RBAC
        - [ ] Confirmer les labels et annotations

        **Description:** $DESCRIPTION

        GÃ©nÃ©rÃ© automatiquement le $(date)" \
          --head "$BRANCH_NAME" \
          --base main
        
        echo "âœ… Pull Request crÃ©Ã©e pour la branche: $BRANCH_NAME"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-manifest:
    runs-on: ubuntu-latest  
    needs: scaffold-baseline
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: main
        
    - name: Setup variables for manifest
      run: |
        # RÃ©cupÃ©rer les variables du job prÃ©cÃ©dent via artifacts ou les redÃ©finir
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "PROJECT_NAME=${{ github.event.inputs.project_name }}" >> $GITHUB_ENV
          echo "TEAM_NAME=${{ github.event.inputs.team_name }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ github.event.inputs.environment }}" >> $GITHUB_ENV
          echo "DESCRIPTION=${{ github.event.inputs.description }}" >> $GITHUB_ENV
        else
          echo "PROJECT_NAME=auto-test" >> $GITHUB_ENV
          echo "TEAM_NAME=platform" >> $GITHUB_ENV
          echo "ENVIRONMENT=dev" >> $GITHUB_ENV
          echo "DESCRIPTION=Test automatique sur ${{ github.event_name }}" >> $GITHUB_ENV
        fi
        
    - name: Generate XProjectCluster manifest for local apply
      run: |
        
        # CrÃ©er le dossier manifests pour usage local
        mkdir -p manifests-local
        
        # GÃ©nÃ©rer le manifeste XProjectCluster
        cat > "manifests-local/$PROJECT_NAME-$ENVIRONMENT.yaml" <<EOF
        apiVersion: platform.example.com/v1
        kind: XProjectCluster
        metadata:
          name: $PROJECT_NAME-$ENVIRONMENT
          labels:
            platform.example.com/project: $PROJECT_NAME
            platform.example.com/environment: $ENVIRONMENT
            platform.example.com/team: $TEAM_NAME
        spec:
          crossplane:
            compositionRef:
              name: xprojectcluster-v2
          parameters:
            projectName: $PROJECT_NAME
            teamName: $TEAM_NAME
            environment: $ENVIRONMENT
            argocd:
              repoURL: https://github.com/Younesic/project-baselines
              targetRevision: main
        EOF
        
        echo "âœ… Manifeste XProjectCluster gÃ©nÃ©rÃ©: manifests-local/$PROJECT_NAME-$ENVIRONMENT.yaml"
        echo "ðŸ“„ Contenu du manifeste:"
        echo "========================"
        cat "manifests-local/$PROJECT_NAME-$ENVIRONMENT.yaml"
        echo "========================"
        
        echo "ðŸŽ¯ Commandes pour application locale:"
        echo "kubectl apply -f manifests-local/$PROJECT_NAME-$ENVIRONMENT.yaml"
        echo
        echo "ðŸš€ Une fois appliquÃ©, Crossplane crÃ©era:"
        echo "   - Namespace: $PROJECT_NAME-$ENVIRONMENT"
        echo "   - Application ArgoCD: $PROJECT_NAME-$ENVIRONMENT-baseline"
        echo "   - Synchronisation baseline depuis ce repository"
        
    - name: Upload manifest as artifact
      uses: actions/upload-artifact@v4
      with:
        name: crossplane-manifest-${{ github.event.inputs.project_name || 'auto-test' }}-${{ github.event.inputs.environment || 'dev' }}
        path: manifests-local/
        retention-days: 30